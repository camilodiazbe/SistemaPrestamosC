<!DOCTYPE html>
<html>
<head>
<title>Sistema de Pr√©stamos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    font-family:Arial;
    background:#f4f4f4;
    padding:20px;
    margin:0;
}

h2{text-align:center;}

.top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:15px;
}

.menu-left a{text-decoration:none;margin-right:10px;}

.menu-btn{
    background:#2563eb;
    color:white;
    padding:8px 12px;
    border-radius:8px;
    border:none;
    cursor:pointer;
}

.logout-btn{
    background:#444;
    padding:8px 12px;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
}

.card{
    background:white;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
}

input, select{
    padding:8px;
    margin:5px 0;
    width:100%;
    box-sizing:border-box;
}

button{
    padding:10px 15px;
    background:black;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
    width:100%;
}

.table-container{overflow-x:auto;}

table{
    width:100%;
    background:white;
    border-radius:12px;
    margin-top:20px;
    border-collapse:collapse;
    font-size:13px;
    min-width:900px;
}

th,td{
    padding:8px;
    text-align:center;
    border-bottom:1px solid #ddd;
}

.activo{color:green;font-weight:bold}
.vencido{color:red;font-weight:bold}
.pagado{color:blue;font-weight:bold}

@media (min-width:768px){
    input, select{width:auto;}
    button{width:auto;}
}
</style>

<script>
function calcularPreview(){
    let monto = parseFloat(document.getElementById("monto").value) || 0;
    let interes = parseFloat(document.getElementById("interes").value) || 0;
    let total = monto + (monto * interes / 100);

    let formatoCOP = new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 2
    });

    document.getElementById("preview").innerText =
        "Total sin mora: " + formatoCOP.format(total);
}

/* =========================
   CALCULAR FECHA AUTOM√ÅTICA
========================= */
function actualizarFechaPago(){

    let fechaPrestamoInput = document.querySelector("input[name='fecha_prestamo']");
    let plazoInput = document.querySelector("input[name='plazo_dias']");
    let fechaPagoInput = document.querySelector("input[name='fecha_pago']");

    let fechaPrestamo = fechaPrestamoInput.value;
    let plazo = parseInt(plazoInput.value);

    if(fechaPrestamo && plazo > 0){

        let fecha = new Date(fechaPrestamo);
        fecha.setDate(fecha.getDate() + plazo);

        let a√±o = fecha.getFullYear();
        let mes = String(fecha.getMonth() + 1).padStart(2,'0');
        let dia = String(fecha.getDate()).padStart(2,'0');

        fechaPagoInput.value = `${a√±o}-${mes}-${dia}`;
    }
}

/* =========================
   MODAL EDITAR
========================= */
function abrirModal(id,nombre,cedula,celular,monto,interes,fecha_prestamo,fecha_pago,medio,objeto,tipo){

    document.getElementById("formEditar").action = "/editar_prestamo/" + id;

    document.getElementById("edit_nombre").value = nombre;
    document.getElementById("edit_cedula").value = cedula;
    document.getElementById("edit_celular").value = celular;
    document.getElementById("edit_monto").value = monto;
    document.getElementById("edit_interes").value = interes;
    document.getElementById("edit_fecha_prestamo").value = fecha_prestamo;
    document.getElementById("edit_fecha_pago").value = fecha_pago;
    document.getElementById("edit_medio").value = medio;
    document.getElementById("edit_objeto").value = objeto;
    document.getElementById("edit_tipo").value = tipo;

    document.getElementById("modalEditar").style.display = "block";
}

function cerrarModal(){
    document.getElementById("modalEditar").style.display = "none";
}

</script>
</head>
<body>

<div class="top-bar">
    <div class="menu-left">
        <a href="/estadisticas">
            <button class="menu-btn">üìä Estad√≠sticas</button>
        </a>
    </div>
    <div>
        <a href="/logout">
            <button class="logout-btn">Cerrar sesi√≥n</button>
        </a>
    </div>
</div>

<h2>üí∞ Sistema de Pr√©stamos Camilo Marrugo üíµ</h2>

<div class="card">
<h3>Registrar Pr√©stamo</h3>
<form method="POST" action="/agregar">
<input name="nombre" placeholder="Nombre completo" required>
<input name="cedula" placeholder="N√∫mero de c√©dula" required>
<input name="celular" placeholder="Celular" required>

<input id="monto" name="monto" type="number" placeholder="Monto" onkeyup="calcularPreview()" required>
<input id="interes" name="interes" type="number" placeholder="% Inter√©s" onkeyup="calcularPreview()" required>

<input name="fecha_prestamo" type="date" required
onchange="actualizarFechaPago()">
<input name="fecha_pago" type="date" readonly style="background:#eee;">

<input name="medio" placeholder="Nequi / Efectivo" required>
<input name="objeto" placeholder="Objeto en garant√≠a" required>

<select name="tipo_prestamo" required>
<option value="fijo">Pr√©stamo con plazo</option>
<option value="indefinido">Pr√©stamo indefinido</option>
</select>

<input name="plazo_dias" type="number" 
placeholder="Plazo en d√≠as (si es fijo)"
onkeyup="actualizarFechaPago()">

<p id="preview"></p>
<button type="submit">Registrar</button>
</form>
</div>

<div class="table-container">
<table>
<tr>
<th>Cliente</th>
<th>C√©dula</th>
<th>Celular</th>
<th>Tipo</th>
<th>Monto</th>
<th>%</th>
<th>Medio</th>
<th>Garant√≠a</th>
<th>Fecha Pr√©stamo</th>
<th>Fecha Pago</th>
<th>Mora</th>
<th>D√≠as vencidos</th>
<th>Vence en</th>
<th>Total Deuda</th>
<th>Estado</th>
<th>Acciones</th>
</tr>

{% for p in prestamos %}
<tr>
<td>{{p.nombre}}</td>
<td>{{p.cedula}}</td>
<td>{{p.celular}}</td>
<td>{{p.tipo_prestamo}}</td>
<td>${{p.monto | cop}}</td>
<td>{{p.interes}}%</td>
<td>{{p.medio}}</td>
<td>{{p.objeto}}</td>
<td>{{p.fecha_prestamo}}</td>
<td>{{p.fecha_pago}}</td>
<td>{{p.mora | cop}}</td>
<td>{{p.dias}}</td>

<td>
{% if p.dias_restantes == "‚àû" %}
‚àû
{% elif p.pagado == 1 %}
‚Äî
{% elif p.dias_restantes > 0 %}
{{p.dias_restantes}} d√≠as
{% else %} 
0 d√≠as
{% endif %} 
</td>


<td><strong>{{ p.total | cop }}</strong></td>

<td>
{% if p.pagado == 1 %}
<span class="pagado">Pagado</span>
{% elif p.dias > 0 %}
<span class="vencido">Vencido</span>
{% else %}
<span class="activo">Activo</span>
{% endif %}
</td>

<td>

{% if p.pagado == 0 %}

{% if p.tipo_prestamo == "indefinido" %}
<a href="/mes_pagado/{{p.id}}">
<button style="background:green;margin-top:5px;">Mes Pagado</button>
</a>
{% endif %}

<form method="POST" action="/abonar/{{p.id}}">
<input name="abono" type="number" placeholder="Abono" required>
<button type="submit">Abonar</button>
</form>

<a href="/pagar/{{p.id}}">
<button>Pagar Total</button>
</a>

<button type="button"
onclick="abrirModal(
'{{p.id}}',
'{{p.nombre}}',
'{{p.cedula}}',
'{{p.celular}}',
'{{p.monto}}',
'{{p.interes}}',
'{{p.fecha_prestamo}}',
'{{p.fecha_pago}}',
'{{p.medio}}',
'{{p.objeto}}',
'{{p.tipo_prestamo}}'
)"
style="background:#2563eb;margin-top:5px;">
Editar
</button>

{% endif %}

<a href="/eliminar/{{p.id}}">
<button style="background:red;margin-top:5px;">Eliminar</button>
</a>

</td>
</tr>
{% endfor %}
</table>
</div>

<!-- MODAL -->
<div id="modalEditar" style="display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%); background:white; padding:20px; border-radius:12px; width:90%; max-width:500px; box-shadow:0 0 15px rgba(0,0,0,0.3); z-index:1000;">

<h3>Editar Pr√©stamo</h3>

<form method="POST" id="formEditar">
<input name="nombre" id="edit_nombre" required>
<input name="cedula" id="edit_cedula" required>
<input name="celular" id="edit_celular" required>
<input name="monto" id="edit_monto" type="number" required>
<input name="interes" id="edit_interes" type="number" required>
<input name="fecha_prestamo" id="edit_fecha_prestamo" type="date" required>
<input name="fecha_pago" id="edit_fecha_pago" type="date" required>
<input name="medio" id="edit_medio" required>
<input name="objeto" id="edit_objeto" required>

<select name="tipo_prestamo" id="edit_tipo">
<option value="fijo">Pr√©stamo con plazo</option>
<option value="indefinido">Pr√©stamo indefinido</option>
</select>

<input name="plazo_dias" id="edit_plazo" type="number">

<br><br>

<button type="submit" style="background:#2563eb;">Guardar Cambios</button>
<button type="button" onclick="cerrarModal()" style="background:#444;margin-top:5px;">Cancelar</button>

</form>
</div>

</body>
</html>
